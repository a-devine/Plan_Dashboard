<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Raynor Planning Intelligence v3.5</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1900px; margin: 0 auto; }

        .header {
            background: white;
            padding: 25px 35px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 8px;
        }

        .version-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .intel-status {
            background: #f0fdf4;
            border: 2px solid #10b981;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            color: #065f46;
            font-weight: 600;
        }

        .intel-status.empty {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .upload-box {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .upload-box:hover {
            border-color: #667eea;
            background: #eef2ff;
            transform: translateY(-2px);
        }

        .upload-box.active {
            border-color: #10b981;
            background: #d1fae5;
            border-style: solid;
        }

        .upload-box .icon { font-size: 48px; margin-bottom: 15px; }

        .upload-box .title {
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .upload-box .desc {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 8px;
            text-transform: uppercase;
        }

        .badge.required { background: #fef3c7; color: #92400e; }
        .badge.optional { background: #dbeafe; color: #1e40af; }

        .upload-box .status {
            margin-top: 12px;
            font-size: 13px;
            color: #10b981;
            font-weight: 600;
        }

        .btn {
            padding: 16px 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        .dashboard { display: none; }
        .dashboard.active { display: block; }

        .intelligence-panel {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .intelligence-panel h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .intel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }

        .intel-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 24px;
            border-radius: 12px;
            border-left: 5px solid #667eea;
        }

        .intel-card .label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .intel-card .value {
            font-size: 32px;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .intel-card .detail {
            font-size: 13px;
            color: #475569;
            font-weight: 500;
        }

        .filters {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            flex: 1;
            min-width: 220px;
        }

        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            margin-bottom: 8px;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .work-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            margin: 0;
            font-size: 22px;
        }

        .bulk-actions button {
            padding: 10px 18px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .bulk-actions button:hover {
            background: white;
            color: #667eea;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 650px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8fafc;
        }

        th {
            padding: 16px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background: #e2e8f0;
        }

        tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        td {
            padding: 14px 12px;
            font-size: 13px;
            color: #334155;
        }

        td.has-history {
            background: #faf5ff;
            font-weight: 600;
        }

        .history-badge {
            display: inline-block;
            background: #ede9fe;
            color: #5b21b6;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 6px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #667eea;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #1e293b;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        select.action-select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
        }

        input.notes-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
        }

        input.notes-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1e40af;
        }

        .info-box strong {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üéØ Raynor Planning Intelligence <span class="version-badge">v3.5</span></h1>
                <p style="color: #666; margin-top: 8px; font-size: 15px;">Smart Planning with Pre-loaded Intelligence</p>
            </div>
            <div class="intel-status" id="intelStatus">
                üìä Intelligence: Not Loaded
            </div>
        </div>

        <div class="upload-section">
            <div class="info-box">
                <strong>üöÄ New in v3.5: Pre-loaded Intelligence!</strong>
                Historical PO data is now built-in. Just upload your buying sheet and go!
                Update intelligence every 3-6 months as needed.
            </div>

            <h2 style="margin-bottom: 15px; color: #1e293b; font-size: 24px;">üìÅ Upload Your Buying Sheet</h2>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">Your current planning data will be enhanced with pre-loaded historical intelligence</p>

            <div class="upload-grid">
                <div class="upload-box required" id="buyingBox" onclick="document.getElementById('buyingFile').click()">
                    <div class="icon">üìä</div>
                    <div class="title">Buying Sheet</div>
                    <div class="desc">Your current planning data with on-hand, POs, commits, cushion</div>
                    <span class="badge required">Required</span>
                    <div class="status" id="buyingStatus"></div>
                    <input type="file" id="buyingFile" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload('buying', this.files[0])">
                </div>

                <div class="upload-box" id="historyBox" onclick="document.getElementById('historyFile').click()">
                    <div class="icon">üîÑ</div>
                    <div class="title">Update Intelligence (Optional)</div>
                    <div class="desc">Upload new Past POs (F4311) to refresh historical intelligence (do this every 3-6 months)</div>
                    <span class="badge optional">Optional</span>
                    <div class="status" id="historyStatus"></div>
                    <input type="file" id="historyFile" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload('history', this.files[0])">
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" id="analyzeBtn" onclick="analyze()" disabled>
                    üöÄ Generate Planning Dashboard
                </button>
                <button class="btn btn-secondary btn-small" onclick="exportIntelligence()">
                    üíæ Export Intelligence Data
                </button>
                <button class="btn btn-secondary btn-small" onclick="document.getElementById('importIntelFile').click()">
                    üì• Import Intelligence Data
                </button>
                <input type="file" id="importIntelFile" accept=".json" style="display:none" onchange="importIntelligence(this.files[0])">
            </div>
        </div>

        <div class="dashboard" id="dashboard">
            <!-- Intelligence Summary -->
            <div class="intelligence-panel">
                <h2>üß† Historical Intelligence Summary</h2>
                <div class="intel-grid" id="intelGrid"></div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label>üè≠ Supplier</label>
                    <select id="supplierFilter" onchange="applyFilters()">
                        <option value="">All Suppliers</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üìç Ship To</label>
                    <select id="shipToFilter" onchange="applyFilters()">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üîç Search Item</label>
                    <input type="text" id="searchBox" placeholder="Item # or Description" oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>üìä Show History</label>
                    <select id="historyFilter" onchange="applyFilters()">
                        <option value="">All Items</option>
                        <option value="with">Items with History</option>
                        <option value="without">Items without History</option>
                    </select>
                </div>
            </div>

            <!-- Work Table -->
            <div class="work-table">
                <div class="table-header">
                    <h2>üìã Planning Work Mode</h2>
                    <div class="bulk-actions">
                        <button onclick="markSelected('Ordered')">‚úÖ Mark Ordered</button>
                        <button onclick="markSelected('Skip')">‚è≠Ô∏è Skip</button>
                        <button onclick="exportWork()">üíæ Export</button>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th class="sortable" onclick="sortTable('item')">Item #</th>
                                <th class="sortable" onclick="sortTable('description')">Description</th>
                                <th class="sortable" onclick="sortTable('supplier')">Supplier</th>
                                <th class="sortable" onclick="sortTable('shipTo')">Ship To</th>
                                <th class="sortable" onclick="sortTable('onHand')">On Hand</th>
                                <th class="sortable" onclick="sortTable('onPO')">On PO</th>
                                <th class="sortable" onclick="sortTable('cushion')">Cushion</th>
                                <th>
                                    üìä Avg Qty
                                    <span class="tooltip">‚ÑπÔ∏è
                                        <span class="tooltiptext">Average order quantity from historical POs (pre-loaded)</span>
                                    </span>
                                </th>
                                <th>
                                    üìç Typical Plant
                                    <span class="tooltip">‚ÑπÔ∏è
                                        <span class="tooltiptext">Most frequently used ship-to plant based on past orders</span>
                                    </span>
                                </th>
                                <th>
                                    üìÖ Last Ordered
                                    <span class="tooltip">‚ÑπÔ∏è
                                        <span class="tooltiptext">Date of most recent PO for this item</span>
                                    </span>
                                </th>
                                <th>Action</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let buyingData = null;
        let historyData = null;
        let processedData = [];
        let historyIntel = {};
        let intelligenceLastUpdated = null;

        // Load pre-loaded intelligence from localStorage or embedded data
        function loadPreloadedIntelligence() {
            const stored = localStorage.getItem('raynor_intelligence');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    historyIntel = data.intelligence || {};
                    intelligenceLastUpdated = data.lastUpdated || null;
                    updateIntelStatus();
                    return true;
                } catch (e) {
                    console.error('Error loading intelligence:', e);
                }
            }
            return false;
        }

        function updateIntelStatus() {
            const status = document.getElementById('intelStatus');
            const count = Object.keys(historyIntel).length;

            if (count > 0) {
                status.className = 'intel-status';
                status.innerHTML = `‚úÖ Intelligence: ${count.toLocaleString()} item/supplier combos loaded`;
                if (intelligenceLastUpdated) {
                    status.innerHTML += ` <span style="font-size: 11px;">(Updated: ${intelligenceLastUpdated})</span>`;
                }
            } else {
                status.className = 'intel-status empty';
                status.innerHTML = '‚ö†Ô∏è No historical intelligence loaded - upload Past POs to build intelligence';
            }
        }

        function saveIntelligence() {
            const data = {
                intelligence: historyIntel,
                lastUpdated: new Date().toISOString().split('T')[0],
                version: '3.5'
            };
            localStorage.setItem('raynor_intelligence', JSON.stringify(data));
            intelligenceLastUpdated = data.lastUpdated;
            updateIntelStatus();
        }

        function exportIntelligence() {
            const data = {
                intelligence: historyIntel,
                lastUpdated: intelligenceLastUpdated || new Date().toISOString().split('T')[0],
                version: '3.5',
                itemCount: Object.keys(historyIntel).length
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raynor-intelligence-${data.lastUpdated}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function importIntelligence(file) {
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (data.version && data.intelligence) {
                    historyIntel = data.intelligence;
                    intelligenceLastUpdated = data.lastUpdated;
                    saveIntelligence();
                    alert(`‚úÖ Intelligence imported successfully!\n${Object.keys(historyIntel).length} item/supplier combinations loaded.`);
                } else {
                    alert('‚ùå Invalid intelligence file format');
                }
            } catch (e) {
                alert('‚ùå Error importing intelligence: ' + e.message);
            }
        }

        async function handleUpload(type, file) {
            if (!file) return;
            const box = document.getElementById(type + 'Box');
            const status = document.getElementById(type + 'Status');
            status.textContent = 'Loading...';

            try {
                const data = await readFile(file);
                status.textContent = `‚úì ${data.length.toLocaleString()} rows loaded`;
                box.classList.add('active');

                if (type === 'buying') {
                    buyingData = data;
                }
                if (type === 'history') {
                    historyData = data;
                    // Automatically rebuild intelligence when new history is uploaded
                    buildHistoricalIntel();
                    saveIntelligence();
                    status.textContent = `‚úì ${data.length.toLocaleString()} rows processed ‚Üí Intelligence updated!`;
                }

                document.getElementById('analyzeBtn').disabled = !buyingData;
            } catch (error) {
                status.textContent = `‚ùå Error: ${error.message}`;
                console.error(error);
            }
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(ws));
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function analyze() {
            document.getElementById('analyzeBtn').textContent = '‚è≥ Building Dashboard...';
            document.getElementById('analyzeBtn').disabled = true;

            setTimeout(() => {
                try {
                    // Process buying sheet with pre-loaded intelligence
                    processedData = buyingData.map((row, idx) => {
                        const item = findCol(row, ['Item Number', 'Item', 'Short Item', 'ITM', 'Short Item No']);
                        const desc = findCol(row, ['Description', 'Desc', 'Item Description', 'DSC']);
                        const supplier = findCol(row, ['Alpha Name', 'Supplier', 'Supplier Name', 'AN8', 'Address Number']) || 'Unknown';
                        const shipTo = findCol(row, ['Ship To Numbers', 'Ship To', 'SHAN', 'Ship To Number']) || '';
                        const onHand = parseFloat(findCol(row, ['Total On Hand', 'On Hand', 'TRQT', 'Quantity On Hand']) || 0);
                        const onPO = parseFloat(findCol(row, ['Quantity On P.O.', 'On PO', 'QTOR', 'Open PO']) || 0);
                        const cushion = parseFloat(findCol(row, ['CUSHION OH+OO-commits-dmdlt', 'Cushion', 'CUSH']) || 0);

                        // Get historical intelligence
                        const key = `${supplier}_${item}`;
                        const intel = historyIntel[key] || {};

                        return {
                            idx,
                            item,
                            description: desc,
                            supplier,
                            shipTo,
                            onHand,
                            onPO,
                            cushion,
                            avgQty: intel.avgQty || null,
                            typicalShipTo: intel.typicalShipTo || null,
                            lastOrderDate: intel.lastOrderDate || null,
                            orderCount: intel.orderCount || 0,
                            hasHistory: !!intel.avgQty,
                            action: 'Pending',
                            notes: '',
                            selected: false
                        };
                    });

                    renderDashboard();
                    document.querySelector('.upload-section').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');

                } catch (error) {
                    alert('Error processing data: ' + error.message);
                    console.error(error);
                    document.getElementById('analyzeBtn').textContent = 'üöÄ Generate Planning Dashboard';
                    document.getElementById('analyzeBtn').disabled = false;
                }
            }, 100);
        }

        function buildHistoricalIntel() {
            historyIntel = {};

            console.log('Building historical intelligence from', historyData.length, 'records');

            historyData.forEach(row => {
                const item = findCol(row, ['Short Item No', 'Item Number', 'Item']);
                const supplier = findCol(row, ['Address Number', 'Supp No', 'AN8']);
                const shipTo = findCol(row, ['Ship To Number', 'Ship To']);
                const qtyOrdered = parseFloat(findCol(row, ['Quantity Ordered']) || 0);
                const qtyReceived = parseFloat(findCol(row, ['Quantity Received']) || 0);
                const orderDate = findCol(row, ['Order Date']);

                if (!item || !supplier || qtyOrdered === 0) return;

                // Only use fully received orders for intelligence
                if (qtyReceived <= 0 || qtyReceived < qtyOrdered * 0.95) return;

                const key = `${supplier}_${item}`;

                if (!historyIntel[key]) {
                    historyIntel[key] = {
                        orders: [],
                        avgQty: 0,
                        typicalShipTo: null,
                        lastOrderDate: null,
                        orderCount: 0
                    };
                }

                historyIntel[key].orders.push({
                    qty: qtyOrdered,
                    shipTo: shipTo,
                    date: orderDate
                });
            });

            // Calculate intelligence metrics
            Object.keys(historyIntel).forEach(key => {
                const intel = historyIntel[key];
                const orders = intel.orders;

                intel.orderCount = orders.length;

                // Average quantity
                intel.avgQty = Math.round(
                    orders.reduce((sum, o) => sum + o.qty, 0) / orders.length
                );

                // Most common ship-to
                const shipToCounts = {};
                orders.forEach(o => {
                    if (o.shipTo) {
                        shipToCounts[o.shipTo] = (shipToCounts[o.shipTo] || 0) + 1;
                    }
                });

                if (Object.keys(shipToCounts).length > 0) {
                    intel.typicalShipTo = Object.keys(shipToCounts).reduce((a, b) =>
                        shipToCounts[a] > shipToCounts[b] ? a : b
                    );
                }

                // Last order date
                const sortedOrders = orders.sort((a, b) =>
                    (b.date || '').toString().localeCompare((a.date || '').toString())
                );
                intel.lastOrderDate = sortedOrders[0]?.date;

                // Remove temporary orders array to save space
                delete intel.orders;
            });

            console.log('Built intelligence for', Object.keys(historyIntel).length, 'item/supplier combinations');
        }

        function renderDashboard() {
            renderIntelSummary();
            populateFilters();
            renderTable();
        }

        function renderIntelSummary() {
            const withHistory = processedData.filter(i => i.hasHistory).length;
            const totalOrders = Object.values(historyIntel).reduce((sum, i) => sum + i.orderCount, 0);
            const uniqueSuppliers = new Set(Object.keys(historyIntel).map(k => k.split('_')[0])).size;

            const html = `
                <div class="intel-card">
                    <div class="label">üìä Items with History</div>
                    <div class="value">${withHistory}</div>
                    <div class="detail">Have historical PO data</div>
                </div>
                <div class="intel-card" style="border-left-color: #10b981;">
                    <div class="label">üìú Historical Orders</div>
                    <div class="value">${totalOrders.toLocaleString()}</div>
                    <div class="detail">POs analyzed</div>
                </div>
                <div class="intel-card" style="border-left-color: #f59e0b;">
                    <div class="label">üè≠ Suppliers</div>
                    <div class="value">${uniqueSuppliers}</div>
                    <div class="detail">With history data</div>
                </div>
                <div class="intel-card" style="border-left-color: #6366f1;">
                    <div class="label">üìã Total Items</div>
                    <div class="value">${processedData.length}</div>
                    <div class="detail">In buying sheet</div>
                </div>
            `;

            document.getElementById('intelGrid').innerHTML = html;
        }

        function populateFilters() {
            const suppliers = [...new Set(processedData.map(i => i.supplier))].sort();
            const supplierSelect = document.getElementById('supplierFilter');
            supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
            suppliers.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                supplierSelect.appendChild(opt);
            });

            const shipTos = [...new Set(processedData.map(i => i.shipTo).filter(s => s))].sort();
            const shipToSelect = document.getElementById('shipToFilter');
            shipToSelect.innerHTML = '<option value="">All Locations</option>';
            shipTos.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                shipToSelect.appendChild(opt);
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const filtered = getFilteredData();

            filtered.forEach(item => {
                const tr = document.createElement('tr');

                const historyClass = item.hasHistory ? 'has-history' : '';
                const historyBadge = item.hasHistory ? '<span class="history-badge">HISTORY</span>' : '';

                tr.innerHTML = `
                    <td><input type="checkbox" ${item.selected ? 'checked' : ''} onchange="toggleSelect(${item.idx})"></td>
                    <td>${item.item}</td>
                    <td>${item.description}${historyBadge}</td>
                    <td>${item.supplier}</td>
                    <td>${item.shipTo}</td>
                    <td>${fmt(item.onHand)}</td>
                    <td>${fmt(item.onPO)}</td>
                    <td style="color: ${item.cushion < 0 ? '#dc2626' : '#059669'}; font-weight: 700;">${fmt(item.cushion)}</td>
                    <td class="${historyClass}">
                        ${item.avgQty ? '<strong>' + fmt(item.avgQty) + '</strong>' : '-'}
                        ${item.orderCount > 0 ? '<div style="font-size: 11px; color: #64748b; margin-top: 2px;">' + item.orderCount + ' orders</div>' : ''}
                    </td>
                    <td class="${historyClass}">${item.typicalShipTo || '-'}</td>
                    <td class="${historyClass}">${item.lastOrderDate || '-'}</td>
                    <td>
                        <select class="action-select" onchange="updateAction(${item.idx}, this.value)">
                            <option value="Pending" ${item.action === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Ordered" ${item.action === 'Ordered' ? 'selected' : ''}>Ordered</option>
                            <option value="Skip" ${item.action === 'Skip' ? 'selected' : ''}>Skip</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" class="notes-input" value="${item.notes}"
                               onchange="updateNotes(${item.idx}, this.value)"
                               placeholder="Add notes...">
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        function getFilteredData() {
            const supplier = document.getElementById('supplierFilter').value;
            const shipTo = document.getElementById('shipToFilter').value;
            const search = document.getElementById('searchBox').value.toLowerCase();
            const history = document.getElementById('historyFilter').value;

            return processedData.filter(item => {
                if (supplier && item.supplier !== supplier) return false;
                if (shipTo && item.shipTo !== shipTo) return false;
                if (search && !item.item.toLowerCase().includes(search) &&
                    !item.description.toLowerCase().includes(search)) return false;
                if (history === 'with' && !item.hasHistory) return false;
                if (history === 'without' && item.hasHistory) return false;
                return true;
            });
        }

        function applyFilters() {
            renderTable();
        }

        function toggleSelect(idx) {
            processedData[idx].selected = !processedData[idx].selected;
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            processedData.forEach(item => item.selected = checked);
            renderTable();
        }

        function updateAction(idx, value) {
            processedData[idx].action = value;
        }

        function updateNotes(idx, value) {
            processedData[idx].notes = value;
        }

        function markSelected(action) {
            processedData.forEach(item => {
                if (item.selected) item.action = action;
            });
            renderTable();
        }

        function sortTable(column) {
            processedData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                if (typeof aVal === 'string') {
                    return aVal.localeCompare(bVal);
                }
                return aVal - bVal;
            });
            renderTable();
        }

        function exportWork() {
            const ws = XLSX.utils.json_to_sheet(processedData.map(i => ({
                'Item': i.item,
                'Description': i.description,
                'Supplier': i.supplier,
                'Ship To': i.shipTo,
                'On Hand': i.onHand,
                'On PO': i.onPO,
                'Cushion': i.cushion,
                'Avg Order Qty (History)': i.avgQty || '',
                'Typical Ship-To Plant': i.typicalShipTo || '',
                'Last Ordered': i.lastOrderDate || '',
                'Order Count': i.orderCount || '',
                'Action': i.action,
                'Notes': i.notes
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Planning Work');
            XLSX.writeFile(wb, `Raynor_Planning_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function findCol(row, names) {
            for (let name of names) {
                if (row[name] !== undefined && row[name] !== null) return row[name];
            }
            return null;
        }

        function fmt(num) {
            if (num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString();
        }

        // Load intelligence on page load
        loadPreloadedIntelligence();
    </script>
</body>
</html>
